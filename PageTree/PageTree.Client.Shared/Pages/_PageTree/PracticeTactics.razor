@using Corelibs.BlazorShared.UI;
@using Corelibs.BlazorViews.Layouts;
@using Microsoft.JSInterop;
@using PageTree.App.UseCases.PracticeTactics.Common;
@using PageTree.App.UseCases.PracticeTactics.Queries;
@using PageTree.App.UseCases.PracticeTactics.Commands;

@attribute [Route(Uris.PracticeTactics)]
@inherits BasePage<GetProjectPracticeTacticsQuery, GetProjectPracticeTacticsQueryOut, PracticeTacticsListVM,
    PageTree.Client.Shared.Views.PracticeTactics.PracticeTactics>

<BackgroundAndContent @ref=@_backgroundOwner Opacity=0.1f>
    <div class="signatures-container">
        <PageTree.Client.Shared.Views.PracticeTactics.PracticeTactics
            @ref=_view
            OnAdd=OnAdd
            OnAddOnTop=OnAddOnTop 
            OnAddOnBottom=OnAddOnBottom
            OnRemove=OnSignature
            OnNameChanged=OnNameChanged
            OnMove=OnMove 
            
            OnPageItemAdd=OnPageItemAdd
            OnPageItemRemove=OnPageItemRemove
            />
    </div>
</BackgroundAndContent>

@code {
    [Parameter] public string PracticeTacticID { get; set; }
    [Parameter] public string ProjectID { get; set; }

    #region Practice Tactic

    private async Task OnAdd(int index)
    {
        await ExecuteCreateCommand(index);
        await RefreshView();
    }

    private async Task OnAddOnTop()
    {
        await ExecuteCreateCommand(0);
        await RefreshView();
    }

    private async Task OnAddOnBottom()
    {
        await ExecuteCreateCommand(int.MaxValue);
        await RefreshView();
    }

    private async Task OnMove(string id, int index)
    {
        await _commands.Execute(new ChangeIndexOfPracticeTacticCommand(id, index));
        await RefreshView();
    }

    private async Task OnSignature(string id)
    {
        await _commands.Execute(new DeletePracticeTacticCommand(id));
        await RefreshView();
    }

    private async Task OnNameChanged(string id, string name)
    {
        await _commands.Execute(new ChangeNameOfPracticeTacticCommand(id, name));
        await RefreshView();
    }

    private Task ExecuteCreateCommand(int index) =>
        _commands.Execute(new CreatePracticeTacticCommand(_vm.RootID, index));

    #endregion

    #region Page Items

    private Task OnPageItemAdd(PracticeTacticVM vm)
    {
        vm.PageItems = vm.PageItems.Append(new()).ToArray();
        return SendUpdateCommandAndRefresh(vm);
    }

    private Task OnPageItemRemove(PracticeTacticVM vm, int index)
    {
        vm.PageItems = vm.PageItems.Where((item, i) => i != index).ToArray();
        return SendUpdateCommandAndRefresh(vm);
    }

    private async Task SendUpdateCommandAndRefresh(PracticeTacticVM vm)
    {
        await _commands.Execute(new UpdateDataOfPracticeTacticCommand(vm.Identity.ID, vm.ToCommandVM()));
        await RefreshView();
    }

    #endregion

    protected override string QueryParameter => ProjectID;
}
